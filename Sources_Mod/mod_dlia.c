//==================================================================================
//| 文件名称 | 软件锁相放大器
//|----------|----------------------------------------------------------------------
//| 文件功能 | 
//|----------|----------------------------------------------------------------------
//| 输入参数 | 无
//|----------|----------------------------------------------------------------------
//| 返回参数 | 无
//==================================================================================
#include "mod_dlia.h"

//%低通 400k_200_9000_1_100
int BL3 = 141;
const FP64 B3[141] = {
    4.510488361e-005,3.151876808e-005,4.228337275e-005,5.528879046e-005,7.08219668e-005,
    8.919350512e-005,0.0001107181306,0.0001357314613,0.0001645696757,0.0001975935302,
    0.0002351665607,0.0002776763286,0.0003255035263,0.0003790357732,0.0004386477231,
    0.0005047110608,0.0005775988684,0.0006576839951,0.0007453151047,0.0008408286958,
    0.0009445233154, 0.001056690468, 0.001177597791, 0.001307483297, 0.001446524751,
    0.001594869886, 0.001752637676, 0.001919920673,  0.00209671515, 0.002282974543,
    0.00247863424, 0.002683590632,  0.00289755105, 0.003120357171, 0.003351625521,
    0.00359099824, 0.003838045988, 0.004092251882, 0.004353071563, 0.004619869404,
    0.004891985096, 0.005168676376, 0.005449169781, 0.005732619669, 0.006018154789,
    0.006304854527, 0.006591760088, 0.006877883337, 0.007162201684, 0.007443676703,
    0.007721264847, 0.007993894629, 0.008260497823, 0.008520008996, 0.008771381341,
    0.009013569914, 0.009245557711, 0.009466356598, 0.009675023146, 0.009870639071,
    0.01005234569,  0.01021933835,  0.01037086919,  0.01050623879,  0.01062485948,
    0.01072616503,      0.0108097,  0.01087507792,   0.0109219905,  0.01095023192,
    0.01095965691,  0.01095023192,   0.0109219905,  0.01087507792,      0.0108097,
    0.01072616503,  0.01062485948,  0.01050623879,  0.01037086919,  0.01021933835,
    0.01005234569, 0.009870639071, 0.009675023146, 0.009466356598, 0.009245557711,
    0.009013569914, 0.008771381341, 0.008520008996, 0.008260497823, 0.007993894629,
    0.007721264847, 0.007443676703, 0.007162201684, 0.006877883337, 0.006591760088,
    0.006304854527, 0.006018154789, 0.005732619669, 0.005449169781, 0.005168676376,
    0.004891985096, 0.004619869404, 0.004353071563, 0.004092251882, 0.003838045988,
    0.00359099824, 0.003351625521, 0.003120357171,  0.00289755105, 0.002683590632,
    0.00247863424, 0.002282974543,  0.00209671515, 0.001919920673, 0.001752637676,
    0.001594869886, 0.001446524751, 0.001307483297, 0.001177597791, 0.001056690468,
    0.0009445233154,0.0008408286958,0.0007453151047,0.0006576839951,0.0005775988684,
    0.0005047110608,0.0004386477231,0.0003790357732,0.0003255035263,0.0002776763286,
    0.0002351665607,0.0001975935302,0.0001645696757,0.0001357314613,0.0001107181306,
    8.919350512e-005,7.08219668e-005,5.528879046e-005,4.228337275e-005,3.151876808e-005,
    4.510488361e-005
};
//%低通 40k_10_500_1_100
int BL4 = 253;
const FP64 B4[253] = {
    3.873295645e-005,1.505172077e-005,1.793723641e-005,2.116442738e-005,2.475648216e-005,
    2.874549318e-005,3.315357753e-005,3.801618732e-005,4.335475023e-005,4.920347419e-005,
    5.55862207e-005,6.25395478e-005,7.00904784e-005,7.827912486e-005,8.713448915e-005,
    9.669708379e-005,0.0001069948776,0.0001180667241,0.0001299403229,0.0001426577946,
    0.0001562518009,0.0001707677584,0.0001862377976,0.0002027021692,0.0002201862517,
    0.0002387280256,0.0002583595051,0.0002791298903,0.0003010746732,0.0003242288367,
    0.0003486081259,0.0003742525005,0.0004012079153,0.0004295207909,0.0004591815523,
    0.0004902100773,0.0005227212096,0.0005566323525,0.0005920462427,0.0006289523444,
    0.0006673804019, 0.000707353116,0.0007488823612, 0.000791992934,0.0008366931579,
    0.0008830018924,0.0009309229208, 0.000980468234, 0.001031636144, 0.001084435848,
    0.001138861524, 0.001194916782, 0.001252589165, 0.001311875763,  0.00137275795,
    0.001435228623, 0.001499265782, 0.001564854872,   0.0016319633, 0.001700568944,
    0.001770637813, 0.001842145924, 0.001915049274, 0.001989309443,  0.00206487719,
    0.002141717821, 0.002219775924, 0.002298998879,  0.00237932452, 0.002460710239,
    0.002543082694,  0.00262636994, 0.002710526111, 0.002795456676, 0.002881105989,
    0.002967388602, 0.003054226981, 0.003141544294, 0.003229249967,  0.00331726647,
    0.003405498806, 0.003493861761,  0.00358225801, 0.003670600243, 0.003758787178,
    0.003846729174, 0.003934322391, 0.004021471832, 0.004108072259, 0.004194031004,
    0.004279241432, 0.004363607615, 0.004447019193, 0.004529383499, 0.004610593896,
    0.004690554924,  0.00476915855, 0.004846310709, 0.004921909887, 0.004995863885,
    0.005068067461, 0.005138433073, 0.005206864327, 0.005273276009,    0.005337568,
    0.005399664864, 0.005459477659, 0.005516922101, 0.005571928807, 0.005624410696,
    0.005674303975, 0.005721534602, 0.005766037386, 0.005807755049, 0.005846620072,
    0.005882586353, 0.005915596616, 0.005945608485, 0.005972574931, 0.005996464752,
    0.006017235108, 0.006034862716, 0.006049317308,  0.00606058538, 0.006068642717,
    0.006073483266,  0.00607509492, 0.006073483266, 0.006068642717,  0.00606058538,
    0.006049317308, 0.006034862716, 0.006017235108, 0.005996464752, 0.005972574931,
    0.005945608485, 0.005915596616, 0.005882586353, 0.005846620072, 0.005807755049,
    0.005766037386, 0.005721534602, 0.005674303975, 0.005624410696, 0.005571928807,
    0.005516922101, 0.005459477659, 0.005399664864,    0.005337568, 0.005273276009,
    0.005206864327, 0.005138433073, 0.005068067461, 0.004995863885, 0.004921909887,
    0.004846310709,  0.00476915855, 0.004690554924, 0.004610593896, 0.004529383499,
    0.004447019193, 0.004363607615, 0.004279241432, 0.004194031004, 0.004108072259,
    0.004021471832, 0.003934322391, 0.003846729174, 0.003758787178, 0.003670600243,
    0.00358225801, 0.003493861761, 0.003405498806,  0.00331726647, 0.003229249967,
    0.003141544294, 0.003054226981, 0.002967388602, 0.002881105989, 0.002795456676,
    0.002710526111,  0.00262636994, 0.002543082694, 0.002460710239,  0.00237932452,
    0.002298998879, 0.002219775924, 0.002141717821,  0.00206487719, 0.001989309443,
    0.001915049274, 0.001842145924, 0.001770637813, 0.001700568944,   0.0016319633,
    0.001564854872, 0.001499265782, 0.001435228623,  0.00137275795, 0.001311875763,
    0.001252589165, 0.001194916782, 0.001138861524, 0.001084435848, 0.001031636144,
    0.000980468234,0.0009309229208,0.0008830018924,0.0008366931579, 0.000791992934,
    0.0007488823612, 0.000707353116,0.0006673804019,0.0006289523444,0.0005920462427,
    0.0005566323525,0.0005227212096,0.0004902100773,0.0004591815523,0.0004295207909,
    0.0004012079153,0.0003742525005,0.0003486081259,0.0003242288367,0.0003010746732,
    0.0002791298903,0.0002583595051,0.0002387280256,0.0002201862517,0.0002027021692,
    0.0001862377976,0.0001707677584,0.0001562518009,0.0001426577946,0.0001299403229,
    0.0001180667241,0.0001069948776,9.669708379e-005,8.713448915e-005,7.827912486e-005,
    7.00904784e-005,6.25395478e-005,5.55862207e-005,4.920347419e-005,4.335475023e-005,
    3.801618732e-005,3.315357753e-005,2.874549318e-005,2.475648216e-005,2.116442738e-005,
    1.793723641e-005,1.505172077e-005,3.873295645e-005
};

#ifdef __cplusplus
#pragma DATA_SECTION("exsram")
#else
#pragma DATA_SECTION(alf_CalBuff,"exsram");
#endif
static FP64 alf_CalBuff[DEF_SAMPLEDOT_MAX] = {0};

#ifdef __cplusplus
#pragma DATA_SECTION("exsram")
#else
#pragma DATA_SECTION(alf_PsdBuff,"exsram");
#endif
static FP64 alf_PsdBuff[DEF_SAMPLEDOT_MAX] = {0};

DLia_t st_DLia = {
    10.0,                       /* 鉴相器频率 KHZ       */
    0.0,                        /* 鉴相器相位 角度      */
    200,                        /* 采样频率 KHZ         */
    DEF_SAMPLEDOT_MAX,          /* 最大点数 */
    
    0,                          /* 采样点数量 */
	NULL,						/* 采样点缓冲区 */
	0,							/* 结果点数 */
	NULL,						/* 结果缓冲区 */
    alf_CalBuff,                /* 计算缓冲区 */
    alf_PsdBuff,                /* 鉴相器波形 */
};

void Mod_FIRFilter(FP64 * pf_Input, INT16U uin_Lenth, const FP64* pf_Factor,INT16U uin_Order,INT16U uin_Avg,INT16U uin_Spand);

//==================================================================================================
//| 函数名称 | Mod_SoftLiaInit
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 初始化数字锁相放大器 生成鉴相器波形
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | pst_DLia: 锁相放大器句柄
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|-------------------------------------------------------------------------------------- 
//| 函数设计 | 
//==================================================================================================
BOOL Mod_DLiaInit(DLia_t* pst_DLia)
{
    INT16U i;
	FP64 f1;
	FP64 fdp,fdt,fw;
	FP64 mPI= 3.1415926535897932384626433832795;

	fdt = 1.0 / (pst_DLia->f_SampleFreq * 1000);        /* 计算采样周期 S*/
	fdp = pst_DLia->f_PsdPhase / 180 * mPI;             /* 转换角度为弧度 */
	fw = pst_DLia->f_PsdFreq * 1000;                    /* 计算正弦波频率 HZ*/

	for(i = 0; i < pst_DLia->uin_SampleMaxDots; i++)
	{
		f1 = sin( 2 * mPI * (fw * i * fdt) + fdp);
		pst_DLia->plf_PsdBuff[i] = f1;
        //喂狗
	}
	return TRUE;
}

//==================================================================================================
//| 函数名称 | Mod_DLiaSetPhase
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 设置锁相放大器相位
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | pst_DLia: 锁相放大器句柄	f_Phase:角度 0~360 b_Init:是否重新生成数组标记
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 |
//==================================================================================================
BOOL Mod_DLiaSetPhase(DLia_t* pst_DLia,FP32 f_Phase,BOOL b_Init)
{
	if(f_Phase >= 0.0 && f_Phase < 360)
	{
		pst_DLia->f_PsdPhase = f_Phase;

		if(SaveToEeprom((INT32U)&pst_DLia->f_PsdPhase) != TRUE)
			return FALSE;
		if(b_Init == TRUE)
			Mod_DLiaInit(pst_DLia);

        return TRUE;
	}
	return FALSE;
}

//==================================================================================================
//| 函数名称 | Mod_DLiaCal
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 数字锁相放大器计算
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | pst_DLia: 锁相放大器句柄
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|-------------------------------------------------------------------------------------- 
//| 函数设计 | 
//==================================================================================================
BOOL  Mod_DLiaCal(DLia_t* pst_DLia,FP64* lf_ResBuff, INT16U* uin_ResLen)
{
    INT16U i;
    
    /*  鉴相器 把采样信号和鉴相器先前生成的信号相乘 
        因为 SinA*SinB= [Cos(A+B)+Cos(A-B)]/2
        所以 VPP*Sin(A)*Sin(A+Phase) = VPP*<[Cos(A+A+Phase)+Cos(A-A-+Phase)]/2>
                                     = VPP*<[Cos(2*A+Phase)+Cos(+-Phase)]/2>
    */
    for(i = 0; i < pst_DLia->uin_SampleLen; i++)
    {
        pst_DLia->plf_CalBuff[i] = pst_DLia->plf_PsdBuff[i] * pst_DLia->plf_SampleBuff[i];
    }
    
    /* 低通滤波器 滤除高频成分 提取包络线 
       把 VPP*<[Cos(2*A+Phase)+Cos(+-Phase)]/2> 通过高通滤波器后
       得到 VPP*[Cos(+-Phase)]/2 当两个信号相位相同时或接近是 Phase ~= 0   
       得到 VPP*[Cos(0)]/2 = VPP/2
    */
    Mod_FIRFilter(pst_DLia->plf_CalBuff, pst_DLia->uin_SampleLen, B3, BL3, 1, 5);				//
    Mod_FIRFilter(pst_DLia->plf_CalBuff, pst_DLia->uin_SampleLen/5, B4, BL4, 1, 10);			//
	return TRUE;
}

//==================================================================================================
//| 函数名称 | Mod_FIRFilter
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | FIR滤波器
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | pf_Input: FIR采样点输入   uin_Lenth:采样点长度
//|          | pf_Factor: FIR系数        uin_Order: FIR阶数
//|          | uin_Avg: 平均滤波         uin_Spand: 结果数组缩放比例 5 = 1000个点缩放为200个点
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|-------------------------------------------------------------------------------------- 
//| 函数设计 | 
//==================================================================================================
void Mod_FIRFilter(FP64 * pf_Input, INT16U uin_Lenth, const FP64* pf_Factor,INT16U uin_Order,INT16U uin_Avg,INT16U uin_Spand)
{
	INT16U i,j;
	FP64 f_tmp = 0;
	FP64 *pf_tmp = 0;

	/* Fir */
	for(j = 0 ; j < uin_Lenth - uin_Order; j++)
	{
		pf_tmp = &pf_Input[j];
		f_tmp = 0;
		for(i = 0 ; i < uin_Order;i++)
		{
			f_tmp += pf_tmp[i]*pf_Factor[i];
		}
		pf_Input[j] = f_tmp;
	}
	/* 填充最后几个无法正常Fir的点 */
    for(i = uin_Lenth - uin_Order; i < uin_Lenth; i++)
	{
    	pf_Input[i]= pf_Input[uin_Lenth - uin_Order -1];
	}

    /* 平均滤波 */
	if(uin_Avg > 1)
	{
		for( i = 0; i<(uin_Lenth - uin_Avg); i++)
		{
			pf_tmp = &pf_Input[i];
			f_tmp = 0;
			for(j = 0; j < uin_Avg; j++)
			{
				f_tmp += pf_tmp[j];
			}
			pf_Input[i] = f_tmp/uin_Avg;
		}
	}

	/* 数组缩放 */
	if(uin_Spand > 1)
	{
		for(i = 0; i < uin_Lenth / uin_Spand; i++)
		{
			pf_tmp = &pf_Input[i*uin_Spand];
			f_tmp = 0;
			for(j = 0 ; j < uin_Spand;j++)
			{
				f_tmp += pf_tmp[j];
			}
			pf_Input[i] = f_tmp/uin_Spand;
		}
	}
}

